name: Sync Database

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1,7,13,19 * * *"

permissions:
  contents: read

concurrency:
  group: database-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Build ehdb-sync
        run: |
          echo "Building ehdb-sync..."
          go build -o bin/ehdb-sync ./cmd/sync

      - name: Create config file
        run: |
          cat > config.yaml << EOF
          database:
            host: ${{ secrets.POSTGRES_HOST }}
            port: ${{ secrets.POSTGRES_PORT }}
            user: ${{ secrets.POSTGRES_USER }}
            password: ${{ secrets.POSTGRES_PASSWORD }}
            dbname: ${{ secrets.POSTGRES_DATABASE }}
            sslmode: disable

          crawler:
            host: exhentai.org
            cookies: "${{ secrets.EHENTAI_COOKIES }}"
            proxy: ""
            retry_times: 3
            wait_for_ip_unban: true
            page_delay_seconds: 1
            api_delay_seconds: 1

          log_level: info
          EOF

      - name: Sync latest galleries
        run: |
          echo "Syncing latest galleries..."
          ./bin/ehdb-sync sync -config config.yaml -offset 2

      - name: Sync torrents
        run: |
          echo "Syncing torrents..."
          ./bin/ehdb-sync torrent-sync -config config.yaml

      - name: Export PostgreSQL database
        run: |
          echo "Exporting PostgreSQL database..."
          PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} pg_dump -h ${{ secrets.POSTGRES_HOST }} \
            -p ${{ secrets.POSTGRES_PORT }} -Fc -Z "zstd" \
            -U ${{ secrets.POSTGRES_USER }} -f ehentai_db.dump ${{ secrets.POSTGRES_DATABASE }}

      - name: Generate statistics
        run: |
          echo "Generating database statistics..."

          # Collect statistics data
          TOTAL_GALLERIES=$(PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} psql -h ${{ secrets.POSTGRES_HOST }} \
            -p ${{ secrets.POSTGRES_PORT }} -U ${{ secrets.POSTGRES_USER }} \
            -d ${{ secrets.POSTGRES_DATABASE }} -t -c "SELECT COUNT(*) FROM gallery;" | xargs)

          ACTIVE_GALLERIES=$(PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} psql -h ${{ secrets.POSTGRES_HOST }} \
            -p ${{ secrets.POSTGRES_PORT }} -U ${{ secrets.POSTGRES_USER }} \
            -d ${{ secrets.POSTGRES_DATABASE }} -t -c "SELECT COUNT(*) FROM gallery WHERE expunged = FALSE;" | xargs)

          TOTAL_TAGS=$(PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} psql -h ${{ secrets.POSTGRES_HOST }} \
            -p ${{ secrets.POSTGRES_PORT }} -U ${{ secrets.POSTGRES_USER }} \
            -d ${{ secrets.POSTGRES_DATABASE }} -t -c "SELECT COUNT(*) FROM tag;" | xargs)

          TOTAL_TORRENTS=$(PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} psql -h ${{ secrets.POSTGRES_HOST }} \
            -p ${{ secrets.POSTGRES_PORT }} -U ${{ secrets.POSTGRES_USER }} \
            -d ${{ secrets.POSTGRES_DATABASE }} -t -c "SELECT COUNT(*) FROM torrent;" | xargs)

          DB_SIZE=$(PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} psql -h ${{ secrets.POSTGRES_HOST }} \
            -p ${{ secrets.POSTGRES_PORT }} -U ${{ secrets.POSTGRES_USER }} \
            -d ${{ secrets.POSTGRES_DATABASE }} -t -c "SELECT pg_size_pretty(pg_database_size('${{ secrets.POSTGRES_DATABASE }}'));" | xargs)

          # Generate markdown formatted statistics report
          cat > sync_stats.txt << EOF
          ## ðŸ“¦ Database Import

          \`\`\`bash
          # 1. Download the database dump
          wget https://github.com/Slinet6056/ehdb/releases/download/live/ehentai_db.dump

          # 2. Create database (if not exists)
          createdb -U postgres ehentai_db

          # 3. Import the database
          pg_restore -U postgres -d ehentai_db --no-owner --no-privileges -v ehentai_db.dump
          \`\`\`

          **Note: PostgreSQL 17 or later is required.**

          ---

          ## ðŸ“Š Database Statistics

          ### ðŸ“ˆ Overview

          | Metric | Count |
          |--------|-------|
          | Total Galleries | ${TOTAL_GALLERIES} |
          | Active Galleries (Not Expunged) | ${ACTIVE_GALLERIES} |
          | Total Tags | ${TOTAL_TAGS} |
          | Total Torrents | ${TOTAL_TORRENTS} |
          | Database Size | ${DB_SIZE} |

          ### ðŸ“‚ Category Breakdown

          | Category | Count |
          |----------|-------|
          EOF

          # Add category statistics
          PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} psql -h ${{ secrets.POSTGRES_HOST }} \
            -p ${{ secrets.POSTGRES_PORT }} -U ${{ secrets.POSTGRES_USER }} \
            -d ${{ secrets.POSTGRES_DATABASE }} -t -A -F'|' \
            -c "SELECT category, COUNT(*) as count FROM gallery WHERE expunged = FALSE GROUP BY category ORDER BY count DESC;" \
            | while IFS='|' read -r category count; do
              echo "| ${category} | ${count} |" >> sync_stats.txt
            done

          echo "" >> sync_stats.txt
          echo "---" >> sync_stats.txt
          echo "*Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> sync_stats.txt
          echo "" >> sync_stats.txt
          echo "**Sync Type:** Regular Sync (every 6 hours)" >> sync_stats.txt

          cat sync_stats.txt

      - name: Update Live Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: live
          name: Live Sync Database
          body_path: sync_stats.txt
          draft: false
          prerelease: false
          make_latest: true
          files: |
            ehentai_db.dump
          token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          rm -f ehentai_db.dump config.yaml sync_stats.txt
          echo "Cleanup completed"
